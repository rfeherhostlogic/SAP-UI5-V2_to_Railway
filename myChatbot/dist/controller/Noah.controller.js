sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/suite/ui/commons/demo/tutorial/service/AiService","sap/m/Column","sap/m/Text","sap/m/ColumnListItem"],function(e,t,r,a,i,n){"use strict";var o={IDLE:"IDLE",ROUTING:"ROUTING",CARD_LOADING:"CARD_LOADING",CARD_INPUT_REQUIRED:"CARD_INPUT_REQUIRED",RUNNING_CARD:"RUNNING_CARD",CHATTING:"CHATTING",ERROR:"ERROR"};return e.extend("sap.suite.ui.commons.demo.tutorial.controller.Noah",{onInit:function(){this._activeAbortController=null;this._boundDropHandlers=false;this._loadManualCardOptions();this._rebindDummy4PreviewTable()},onAfterRendering:function(){this._bindDropZoneEvents();this._scrollChatToBottom()},onSendNoah:async function(){var e=this.getView().getModel("noah");var t=(e.getProperty("/draftMessage")||"").trim();var a=this._getAttachmentsPayload();var i=e.getProperty("/pendingConfirmation");var n=String(e.getProperty("/manualSelectedCardId")||"").trim();if(!t&&a.length===0&&!n){return}if(i){var s=t.toLowerCase();if(s==="igen"||s==="ok"||s==="futtasd"){e.setProperty("/draftMessage","");await this.onConfirmCardYes();return}if(s==="nem"||s==="megsem"){e.setProperty("/draftMessage","");this.onConfirmCardNo();return}}this._appendMessage("user",this._buildUserMessageWithAttachments(t,a));e.setProperty("/draftMessage","");e.setProperty("/error","");if(n){try{var l=await this._loadCardById(n);this._pushManualRouterLog(l);await this._prefillManualCardAndRun(n,t,a)}catch(e){if(e&&e.name==="AbortError"){this._setState(o.IDLE,"Folyamat megszakitva.");return}this._setError(e)}return}this._setState(o.ROUTING,"Szandek felismerese folyamatban...");try{this._activeAbortController=new AbortController;var d=await r.noahRoute({user_message:t,attachments:a,history:this._getHistoryPayload()},this._activeAbortController.signal);this._pushRouterLog(d);if(d.selected_card_id){await this._loadCardAndContinue(d,t)}else{await this._runFallbackChat(t,a)}}catch(e){if(e&&e.name==="AbortError"){this._setState(o.IDLE,"Folyamat megszakitva.");return}this._setError(e)}finally{this._activeAbortController=null}},onNoahFileChange:function(e){var t=e&&e.getParameter?e.getParameter("files"):[];this._appendFilesAsAttachments(t||[])},onRefreshCardFieldDefault:async function(e){var a=this.getView().getModel("noah");var i=a.getProperty("/activeCard");var n=e&&e.getSource?e.getSource().getBindingContext("noah"):null;var s=n?n.getObject():null;var l=s&&s.field_id?String(s.field_id):"";if(!i||!i.id||!l){return}try{this._setState(o.CARD_LOADING,"Mezo frissitese folyamatban...");this._activeAbortController=new AbortController;var d=await r.noahGetCardConfig(i.id,this._activeAbortController.signal);var u=d&&d.default_field_values?d.default_field_values:{};if(!Object.prototype.hasOwnProperty.call(u,l)){this._setState(o.CARD_INPUT_REQUIRED,"Nincs uj ertek ehhez a mezohoz.");t.show('Nincs uj ertek a "'+l+'" mezohöz.');return}this._applyPrefillValuesToRuntimeFields(function(){var e={};e[l]=u[l];return e}());this._setState(o.CARD_INPUT_REQUIRED,"Mezo frissitve.");t.show("A mezo frissult a legfrissebb schema alapjan.")}catch(e){if(e&&e.name==="AbortError"){this._setState(o.IDLE,"Frissites megszakitva.");return}this._setError(e)}finally{this._activeAbortController=null}},onManualCardSelectChange:async function(e){var t=String(e&&e.getSource?e.getSource().getSelectedKey():"").trim();var r=this.getView().getModel("noah");if(!t){r.setProperty("/activeCard",null);r.setProperty("/activeCardRuntimeFields",[]);r.setProperty("/dummy4PreviewRows",[]);r.setProperty("/dummy4GeneratedSql","");this._rebindDummy4PreviewTable();this._setState(o.IDLE,"Automatikus router mod.");return}try{await this._loadCardById(t);this._setState(o.CARD_INPUT_REQUIRED,"Kartya betoltve. Add meg a mezoertekeket, vagy kuld uzenetet.")}catch(e){this._setError(e)}},onRemoveAttachment:function(e){var t=e.getSource().getBindingContext("noah");if(!t){return}var r=this.getView().getModel("noah");var a=t.getPath();var i=r.getProperty("/attachments")||[];var n=parseInt(a.split("/").pop(),10);if(isNaN(n)||n<0||n>=i.length){return}i.splice(n,1);r.setProperty("/attachments",i)},onRunActiveCard:async function(){var e=this.getView().getModel("noah");var t=e.getProperty("/activeCard");if(!t||!t.id){return}await this._runCard(t.id,(e.getProperty("/draftMessage")||"").trim())},onConfirmCardYes:async function(){var e=this.getView().getModel("noah");var t=e.getProperty("/pendingConfirmation");var r=e.getProperty("/activeCard");e.setProperty("/pendingConfirmation",null);if(!t||!r||!r.id){return}await this._runCard(r.id,t.originalMessage||"")},onConfirmCardNo:function(){var e=this.getView().getModel("noah");e.setProperty("/pendingConfirmation",null);this._appendMessage("assistant","Rendben, nem futtatom a kartyat. Irj pontosabban, vagy folytatom normal chat modban.");this._setState(o.CARD_INPUT_REQUIRED,"Kartya megerosites elutasitva.")},onCancelRun:function(){if(this._activeAbortController){this._activeAbortController.abort();this._activeAbortController=null}this._setState(o.IDLE,"Folyamat megszakitva.")},onCopyNoahMessage:async function(e){var r=e.getSource().getBindingContext("noah");var a=r?r.getObject():null;var i=String(a&&a.content?a.content:"");if(!i){return}try{if(navigator.clipboard&&navigator.clipboard.writeText){await navigator.clipboard.writeText(i)}else{this._copyTextFallback(i)}t.show("AI valasz masolva.")}catch(e){try{this._copyTextFallback(i);t.show("AI valasz masolva.")}catch(e){t.show("Masolas nem sikerult.")}}},_loadCardAndContinue:async function(e,t){var r=this.getView().getModel("noah");this._setState(o.CARD_LOADING,"Kartya betoltese: "+(e.ui_hint||e.selected_card_id)+"...");var a=await this._loadCardById(e.selected_card_id);var i=this._runtimeFieldsToPrefill(r.getProperty("/activeCardRuntimeFields")||[]);var n=(e.required_fields||[]).filter(function(e){return e&&e.field_id!=="schema_hint"});var s=this._buildRuntimeFields(a.fields||[],i.concat(n));r.setProperty("/activeCard",a);r.setProperty("/activeCardRuntimeFields",s);if(a.id==="dummy-4"){await this._refreshDummy4SchemaHintFromSource()}if(e.needs_confirmation||Number(e.confidence||0)<.55){r.setProperty("/pendingConfirmation",{originalMessage:t});this._appendMessage("assistant","Alacsony bizonyossag. Futtassam ezt a kartyat: "+a.name+"?");this._setState(o.CARD_INPUT_REQUIRED,"Var megerositesre.");return}await this._runCard(a.id,t)},_refreshDummy4SchemaHintFromSource:async function(){var e=this.getView().getModel("noah");var t=e.getProperty("/activeCard");if(!t||t.id!=="dummy-4"){return}this._activeAbortController=new AbortController;var a=await r.noahGetCardConfig(t.id,this._activeAbortController.signal);var i=a&&a.default_field_values?a.default_field_values:{};if(!Object.prototype.hasOwnProperty.call(i,"schema_hint")){return}this._applyPrefillValuesToRuntimeFields({schema_hint:i.schema_hint})},_runCard:async function(e,t){var a=this.getView().getModel("noah");var i=this._getAttachmentsPayload();var n=this._collectCardFieldValues();var s=this._validateRequiredFields();if(s.length>0){this._setState(o.CARD_INPUT_REQUIRED,"Hianyzo kotelezo mezok: "+s.join(", "));return}this._setState(o.RUNNING_CARD,"Kartya futtatasa folyamatban...");a.setProperty("/error","");try{this._activeAbortController=new AbortController;var l=await r.noahRunCard({card_id:e,user_message:t||"",field_values:n,attachments:i},this._activeAbortController.signal);this._applyCardSpecificPayload(e,l&&l.payload?l.payload:null);this._appendMessage("assistant","["+(l.card_name||e)+"]\n"+(l.result||"Nincs valasz."));this._clearComposerAfterRun();this._setState(o.IDLE,"Kartya lefutott.")}catch(e){if(e&&e.name==="AbortError"){this._setState(o.IDLE,"Kartya futtatasa megszakitva.");return}this._setError(e)}finally{this._activeAbortController=null}},_runFallbackChat:async function(e,t){this._setState(o.CHATTING,"Normal AI valasz keszitese...");try{this._activeAbortController=new AbortController;var a=await r.noahChat({message:e||"",attachments:t||[],history:this._getHistoryPayload()},this._activeAbortController.signal);this._appendMessage("assistant",a&&a.message?a.message:"Nincs valasz.");this._clearComposerAfterRun();this._setState(o.IDLE,"Kesz.")}catch(e){if(e&&e.name==="AbortError"){this._setState(o.IDLE,"Chat megszakitva.");return}this._setError(e)}},_bindDropZoneEvents:function(){if(this._boundDropHandlers){return}var e=this.byId("noahDropZone");if(!e||!e.getDomRef()){return}var t=e.getDomRef();var r=this;t.addEventListener("dragover",function(e){e.preventDefault();t.classList.add("noahDropZoneActive")});t.addEventListener("dragleave",function(){t.classList.remove("noahDropZoneActive")});t.addEventListener("drop",function(e){e.preventDefault();t.classList.remove("noahDropZoneActive");var a=e.dataTransfer&&e.dataTransfer.files?e.dataTransfer.files:[];r._appendFilesAsAttachments(a)});this._boundDropHandlers=true},_appendFilesAsAttachments:function(e){var r=this.getView().getModel("noah");var a=r.getProperty("/attachments")||[];var i=Array.prototype.slice.call(e||[]);var n={};a.forEach(function(e){n[e.name+"|"+e.size+"|"+e.type]=true});i.forEach(function(e){var t={name:e.name||"unknown",type:e.type||"application/octet-stream",size:Number(e.size||0)};var r=t.name+"|"+t.size+"|"+t.type;if(!n[r]){n[r]=true;a.push(t)}});r.setProperty("/attachments",a);t.show(i.length+" fajl hozzaadva.")},_buildRuntimeFields:function(e,t){var r={};(t||[]).forEach(function(e){if(e&&e.field_id){r[String(e.field_id)]=e.prefill==null?"":String(e.prefill)}});return(e||[]).map(function(e){var t=String(e.field_id||"");return{field_id:t,label:e.label||t,type:e.type||"text",required:!!e.required,placeholder:e.placeholder||"",validation:e.validation||{},value:Object.prototype.hasOwnProperty.call(r,t)?r[t]:""}})},_validateRequiredFields:function(){var e=this.getView().getModel("noah");var t=e.getProperty("/activeCardRuntimeFields")||[];return t.filter(function(e){return e.required&&!String(e.value||"").trim()}).map(function(e){return e.label||e.field_id})},_collectCardFieldValues:function(){var e=this.getView().getModel("noah");var t=e.getProperty("/activeCardRuntimeFields")||[];var r={};t.forEach(function(e){r[e.field_id]=String(e.value==null?"":e.value).trim()});return r},_getHistoryPayload:function(){var e=this.getView().getModel("noah");return(e.getProperty("/messages")||[]).map(function(e){return{role:e.role,content:e.content}})},_getAttachmentsPayload:function(){var e=this.getView().getModel("noah");return(e.getProperty("/attachments")||[]).map(function(e){return{name:e.name,type:e.type,size:Number(e.size||0)}})},_buildUserMessageWithAttachments:function(e,t){var r=String(e||"");if(!t||t.length===0){return r}var a=t.map(function(e){return e.name+" ("+e.type+", "+e.size+" B)"}).join(", ");return r+"\n\n[Csatolmanyok: "+a+"]"},_copyTextFallback:function(e){var t=document.createElement("textarea");t.value=String(e||"");t.setAttribute("readonly","readonly");t.style.position="fixed";t.style.left="-9999px";document.body.appendChild(t);t.select();document.execCommand("copy");document.body.removeChild(t)},_appendMessage:function(e,t){var r=this.getView().getModel("noah");var a=r.getProperty("/messages")||[];a.push({role:e,content:String(t||"")});r.setProperty("/messages",a);this._scrollChatToBottom()},_pushRouterLog:function(e){var t=this.getView().getModel("noah");var r=t.getProperty("/routerLog")||[];r.unshift({selected_card_id:e.selected_card_id,confidence:Number(e.confidence||0).toFixed(2),rationale_short:e.rationale_short||"",timestamp:(new Date).toLocaleString("hu-HU")});t.setProperty("/routerLog",r.slice(0,20))},_scrollChatToBottom:function(){var e=this.byId("noahChatPanel");if(!e||!e.getDomRef()){return}setTimeout(function(){var t=e.getDomRef();if(t){var r=t.querySelector(".sapMLIB:last-child");if(r&&r.scrollIntoView){r.scrollIntoView({block:"end",inline:"nearest"})}else{t.scrollTop=t.scrollHeight+9999}}},0)},_loadCardById:async function(e){this._activeAbortController=new AbortController;var t=await r.noahGetCardConfig(e,this._activeAbortController.signal);var a=t&&t.card?t.card:null;if(!a){throw new Error("Nem sikerult a kartya konfiguracio lekerese.")}var i=this._mapToPrefillArray(t&&t.default_field_values?t.default_field_values:{});this.getView().getModel("noah").setProperty("/activeCard",a);this.getView().getModel("noah").setProperty("/activeCardRuntimeFields",this._buildRuntimeFields(a.fields||[],i));this._setState(o.CARD_LOADING,"Kartya betoltve: "+a.name);return a},_prefillManualCardAndRun:async function(e,t,a){var i=this.getView().getModel("noah");this._setState(o.CARD_LOADING,"Kartya mezok automatikus kitoltese...");this._activeAbortController=new AbortController;var n=await r.noahPrefillCard({card_id:e,user_message:t||"",attachments:a||[]},this._activeAbortController.signal);var s=n&&n.field_values?n.field_values:{};this._applyPrefillValuesToRuntimeFields(s);var l=this._validateRequiredFields();if(l.length>0){this._setState(o.CARD_INPUT_REQUIRED,"Kártya érték megadás szükséges");this._appendMessage("assistant","Kártya érték megadás szükséges");return}await this._runCard(e,t||"");i.setProperty("/manualSelectedCardId","")},_loadManualCardOptions:function(){var e=this.getView().getModel("noah")||this.getOwnerComponent().getModel("noah");r.noahListCards().then(function(t){var r=Array.isArray(t&&t.cards)?t.cards:[];var a=[{id:"",name:"Automatikus router"}].concat(r.map(function(e){return{id:e.id,name:e.name}}));e.setProperty("/manualCardOptions",a)}).catch(function(){e.setProperty("/manualCardOptions",[{id:"",name:"Automatikus router"}])})},_pushManualRouterLog:function(e){var t=this.getView().getModel("noah");var r=t.getProperty("/routerLog")||[];r.unshift({selected_card_id:e&&e.id?e.id:"manual",confidence:"1.00",rationale_short:"Manuálisan kiválasztva: "+(e&&e.name?e.name:"ismeretlen")+" Joker.",timestamp:(new Date).toLocaleString("hu-HU")});t.setProperty("/routerLog",r.slice(0,20))},_applyCardSpecificPayload:function(e,t){var r=this.getView().getModel("noah");if(e==="dummy-4"&&t){var a=Array.isArray(t.rows)?t.rows:[];r.setProperty("/dummy4PreviewRows",a);r.setProperty("/dummy4GeneratedSql",String(t.generatedSql||""));this._rebindDummy4PreviewTable();return}r.setProperty("/dummy4PreviewRows",[]);r.setProperty("/dummy4GeneratedSql","");this._rebindDummy4PreviewTable()},_rebindDummy4PreviewTable:function(){var e=this.byId("noahDummy4PreviewTable");var t=this.getView().getModel("noah");var r=t?t.getProperty("/dummy4PreviewRows")||[]:[];if(!e){return}e.unbindItems();e.removeAllColumns();var o=this._extractColumns(r);if(o.length===0){return}o.forEach(function(t){e.addColumn(new a({header:new i({text:t})}))});var s=o.map(function(e){return new i({text:"{noah>"+e+"}",wrapping:true})});e.bindItems({path:"noah>/dummy4PreviewRows",template:new n({cells:s}),templateShareable:false})},_extractColumns:function(e){var t={};var r=[];(e||[]).forEach(function(e){Object.keys(e||{}).forEach(function(e){if(t[e]){return}t[e]=true;r.push(e)})});return r},_applyPrefillValuesToRuntimeFields:function(e){var t=this.getView().getModel("noah");var r=t.getProperty("/activeCardRuntimeFields")||[];var a=r.map(function(t){var r=String(t.field_id||"");var a=Object.prototype.hasOwnProperty.call(e||{},r);return Object.assign({},t,{value:a?String(e[r]==null?"":e[r]):t.value})});t.setProperty("/activeCardRuntimeFields",a)},_mapToPrefillArray:function(e){var t=[];var r=e&&typeof e==="object"?e:{};Object.keys(r).forEach(function(e){t.push({field_id:String(e),prefill:r[e]==null?"":String(r[e])})});return t},_runtimeFieldsToPrefill:function(e){return(e||[]).map(function(e){return{field_id:String(e.field_id||""),prefill:e.value==null?"":String(e.value)}}).filter(function(e){return!!e.field_id})},_clearComposerAfterRun:function(){var e=this.getView().getModel("noah");e.setProperty("/draftMessage","");e.setProperty("/attachments",[])},_setState:function(e,t){var r=this.getView().getModel("noah");r.setProperty("/state",e);r.setProperty("/statusText",t||"");if(e!==o.ERROR){r.setProperty("/error","")}},_setError:function(e){var r=this.getView().getModel("noah");var a=e&&e.message?e.message:"Ismeretlen hiba.";r.setProperty("/error",a);this._setState(o.ERROR,"Hiba tortent.");t.show(a)}})});
//# sourceMappingURL=Noah.controller.js.map