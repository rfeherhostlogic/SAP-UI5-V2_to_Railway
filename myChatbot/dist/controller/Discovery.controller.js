sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/suite/ui/commons/demo/tutorial/service/AiService","sap/m/Column","sap/m/Text","sap/m/ColumnListItem"],function(e,t,r,s,i,a){"use strict";return e.extend("sap.suite.ui.commons.demo.tutorial.controller.Discovery",{onInit:function(){this._statusTimer=null},onExit:function(){this._clearStatusTimer()},onStartDiscovery:async function(){var e=this.getView().getModel("discovery");e.setProperty("/busy",true);e.setProperty("/error","");e.setProperty("/suggestions",[]);try{var s=await r.runDiscovery();e.setProperty("/schemaTables",s.tables||[]);e.setProperty("/promptPreview",s.prompt||"");e.setProperty("/suggestions",s.suggestions||[]);this._resetMlFlow()}catch(r){var i=this._extractError(r,"Felfedezesi hiba tortent.");e.setProperty("/error",i);t.show(i)}finally{e.setProperty("/busy",false)}},onStartMlModel:async function(e){var s=this.getView().getModel("discovery");var i=e.getSource().getBindingContext("discovery");var a=i?i.getObject():null;if(!a){return}this._clearStatusTimer();this._resetMlFlow();s.setProperty("/activeUseCase",a);s.setProperty("/specBusy",true);s.setProperty("/error","");try{var n=await r.discoverySpecChatStart({use_case:a});var o=String(n&&n.question?n.question:"").trim();s.setProperty("/specSessionId",n&&n.session_id?n.session_id:"");s.setProperty("/specStep",Number(n&&n.step?n.step:1));s.setProperty("/specMaxSteps",Number(n&&n.max_steps?n.max_steps:5));s.setProperty("/specDone",false);s.setProperty("/trainingStatus","SPEC_CHAT");s.setProperty("/trainingMessage","Uzleti pontositas: valaszolj a kerdesekre.");if(o){s.setProperty("/specChatMessages",[{role:"assistant",content:o}])}else{s.setProperty("/specChatMessages",[])}}catch(e){var p=this._extractError(e,"Nem sikerult elinditani a specifikacios chatbotot.");s.setProperty("/error",p);s.setProperty("/trainingStatus","ERROR");t.show(p)}finally{s.setProperty("/specBusy",false)}},onSubmitSpecAnswer:async function(){var e=this.getView().getModel("discovery");var s=String(e.getProperty("/specSessionId")||"").trim();var i=String(e.getProperty("/specAnswerDraft")||"").trim();if(!s||!i){return}this._pushChatMessage("user",i);e.setProperty("/specAnswerDraft","");e.setProperty("/specBusy",true);e.setProperty("/error","");try{var a=await r.discoverySpecChatAnswer({session_id:s,answer:i});if(a&&a.done){e.setProperty("/specDone",true);this._pushChatMessage("assistant","Koszonom, osszeallitom a trening specifikaciot es inditom a treninget.");await this._generateSpecAndStartTraining();return}if(a&&a.question){e.setProperty("/specStep",Number(a.step||1));e.setProperty("/specMaxSteps",Number(a.max_steps||5));this._pushChatMessage("assistant",String(a.question))}}catch(r){var n=this._extractError(r,"Specifikacios valasz feldolgozasi hiba.");e.setProperty("/error",n);e.setProperty("/trainingStatus","ERROR");t.show(n)}finally{e.setProperty("/specBusy",false)}},onRetrySpecGeneration:async function(){await this._generateSpecAndStartTraining()},onDownloadTrainingCsv:function(){var e=this.getView().getModel("discovery");var r=String(e.getProperty("/csvDownloadUrl")||"").trim();if(!r){t.show("CSV link nem elerheto.");return}window.open(r,"_blank")},onResetMlFlow:function(){this._clearStatusTimer();this._resetMlFlow()},_generateSpecAndStartTraining:async function(){var e=this.getView().getModel("discovery");var s=String(e.getProperty("/specSessionId")||"").trim();if(!s){return}e.setProperty("/trainingStatus","SPEC_GENERATING");e.setProperty("/trainingMessage","Training specifikacio generalasa...");e.setProperty("/error","");try{var i=await r.discoveryGenerateTrainingSpec({session_id:s});e.setProperty("/trainingSpecYaml",String(i&&i.training_spec_yaml?i.training_spec_yaml:""));e.setProperty("/trainingStatus","TRAINING_STARTING");e.setProperty("/trainingMessage","Training inditasa...");var a=await r.discoveryStartTraining({session_id:s});var n=String(a&&a.job_id?a.job_id:"").trim();if(!n){throw new Error("A training job azonosito hianyzik.")}e.setProperty("/trainingJobId",n);e.setProperty("/trainingStatus","TRAINING_RUNNING");e.setProperty("/trainingProgress",0);e.setProperty("/trainingMessage","Training folyamatban...");this._startStatusPolling(n)}catch(r){var o=this._extractError(r,"Training specifikacio/inditas hiba.");e.setProperty("/error",o);e.setProperty("/trainingStatus","ERROR");t.show(o)}},_startStatusPolling:function(e){var s=this;var i=this.getView().getModel("discovery");this._clearStatusTimer();var a=async function(){try{var n=await r.discoveryGetTrainingStatus({job_id:e});i.setProperty("/trainingStatus",String(n.status||"running").toUpperCase());i.setProperty("/trainingProgress",Number(n.progress||0));i.setProperty("/trainingMessage",String(n.message||"Training folyamatban..."));if(n.status==="done"){s._clearStatusTimer();await s._loadTrainingResult(e);return}if(n.status==="error"){s._clearStatusTimer();i.setProperty("/trainingStatus","ERROR");i.setProperty("/error",String(n.message||"Training hiba."));return}}catch(e){s._clearStatusTimer();var o=s._extractError(e,"Training status hiba.");i.setProperty("/error",o);i.setProperty("/trainingStatus","ERROR");t.show(o);return}s._statusTimer=setTimeout(a,1500)};this._statusTimer=setTimeout(a,500)},_loadTrainingResult:async function(e){var s=this.getView().getModel("discovery");try{var i=await r.discoveryGetTrainingResult({job_id:e});var a=Array.isArray(i&&i.preview_rows)?i.preview_rows.slice(0,50):[];var n=this._extractColumns(a);s.setProperty("/resultPreviewRows",a);s.setProperty("/resultColumns",n);s.setProperty("/metricsItems",this._mapMetricsItems(i&&i.metrics?i.metrics:{}));s.setProperty("/businessSummary",String(i&&i.business_summary?i.business_summary:""));s.setProperty("/csvDownloadUrl",String(i&&i.csv_download_url?i.csv_download_url:""));if(i&&i.training_spec_yaml){s.setProperty("/trainingSpecYaml",String(i.training_spec_yaml))}s.setProperty("/trainingStatus","RESULT_READY");s.setProperty("/trainingMessage","Training befejezve.");this._rebindResultPreviewTable()}catch(e){var o=this._extractError(e,"Training eredmeny lekeresi hiba.");s.setProperty("/error",o);s.setProperty("/trainingStatus","ERROR");t.show(o)}},_rebindResultPreviewTable:function(){var e=this.byId("discoveryPreviewTable");var t=this.getView().getModel("discovery");var r=t.getProperty("/resultPreviewRows")||[];var n=t.getProperty("/resultColumns")||[];if(!e){return}e.unbindItems();e.removeAllColumns();if(r.length===0||n.length===0){return}n.forEach(function(t){e.addColumn(new s({header:new i({text:t})}))});var o=n.map(function(e){return new i({text:"{discovery>"+e+"}",wrapping:true})});e.bindItems({path:"discovery>/resultPreviewRows",template:new a({cells:o}),templateShareable:false})},_mapMetricsItems:function(e){var t=[];var r=e&&typeof e==="object"?e:{};Object.keys(r).forEach(function(e){var s=r[e];t.push({key:e,value:typeof s==="object"?JSON.stringify(s):String(s)})});return t},_extractColumns:function(e){var t={};var r=[];(e||[]).forEach(function(e){Object.keys(e||{}).forEach(function(e){if(t[e]){return}t[e]=true;r.push(e)})});return r},_pushChatMessage:function(e,t){var r=this.getView().getModel("discovery");var s=r.getProperty("/specChatMessages")||[];s.push({role:e,content:String(t||"")});r.setProperty("/specChatMessages",s)},_resetMlFlow:function(){var e=this.getView().getModel("discovery");e.setProperty("/activeUseCase",null);e.setProperty("/specSessionId","");e.setProperty("/specChatMessages",[]);e.setProperty("/specAnswerDraft","");e.setProperty("/specStep",0);e.setProperty("/specMaxSteps",0);e.setProperty("/specDone",false);e.setProperty("/specBusy",false);e.setProperty("/trainingSpecYaml","");e.setProperty("/trainingStatus","IDLE");e.setProperty("/trainingProgress",0);e.setProperty("/trainingMessage","");e.setProperty("/trainingJobId","");e.setProperty("/resultPreviewRows",[]);e.setProperty("/resultColumns",[]);e.setProperty("/metricsItems",[]);e.setProperty("/businessSummary","");e.setProperty("/csvDownloadUrl","");this._rebindResultPreviewTable()},_clearStatusTimer:function(){if(this._statusTimer){clearTimeout(this._statusTimer);this._statusTimer=null}},_extractError:function(e,t){return e&&e.message?e.message:t}})});
//# sourceMappingURL=Discovery.controller.js.map