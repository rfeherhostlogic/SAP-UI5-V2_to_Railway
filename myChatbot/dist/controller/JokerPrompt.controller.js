sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/suite/ui/commons/demo/tutorial/service/AiService","sap/ui/model/odata/v2/ODataModel","sap/ui/model/json/JSONModel","sap/m/Column","sap/m/Text","sap/m/ColumnListItem","sap/viz/ui5/controls/VizFrame","sap/viz/ui5/data/FlattenedDataset","sap/viz/ui5/data/DimensionDefinition","sap/viz/ui5/data/MeasureDefinition","sap/viz/ui5/controls/common/feeds/FeedItem"],function(e,t,r,a,s,o,n,i,m,u,l,y,g){"use strict";return e.extend("sap.suite.ui.commons.demo.tutorial.controller.JokerPrompt",{onInit:function(){this.getOwnerComponent().getRouter().getRoute("jokerPrompt").attachPatternMatched(this._onRouteMatched,this)},onGenerate:async function(){await this._runGenerate(true)},onSend:async function(){await this._runGenerate(false)},onDummy5FileChange:async function(e){var a=this.getView().getModel("jokers");var s=e&&e.getParameter?e.getParameter("files"):null;var o=s&&s[0]?s[0]:null;if(!o){t.show("Valassz egy PDF fajlt.");return}a.setProperty("/generating",true);a.setProperty("/dummy5Summary","");a.setProperty("/dummy5Answer","");a.setProperty("/dummy5DocToken","");try{var n=await r.uploadDummy5Pdf(o);a.setProperty("/dummy5DocToken",n.docToken||"");a.setProperty("/dummy5FileName",n.fileName||o.name||"");t.show("PDF feltoltve es feldolgozva.")}catch(e){t.show(e&&e.message?e.message:"PDF feltoltesi hiba.")}finally{a.setProperty("/generating",false)}},onRunDummy5Summary:async function(){var e=this.getView().getModel("jokers");var a=(e.getProperty("/dummy5DocToken")||"").trim();if(!a){t.show("Elobb tolts fel egy PDF-et.");return}e.setProperty("/generating",true);try{var s=await r.summarizeDummy5({docToken:a});e.setProperty("/dummy5Summary",s.summary||"")}catch(e){t.show(e&&e.message?e.message:"PDF osszegzes hiba.")}finally{e.setProperty("/generating",false)}},onRunDummy5Ask:async function(){var e=this.getView().getModel("jokers");var a=(e.getProperty("/dummy5DocToken")||"").trim();var s=(e.getProperty("/dummy5Question")||"").trim();if(!a){t.show("Elobb tolts fel egy PDF-et.");return}if(!s){t.show("A kerdes mezot toltsd ki.");return}e.setProperty("/generating",true);try{var o=await r.askDummy5({docToken:a,question:s});e.setProperty("/dummy5Answer",o.answer||"")}catch(e){t.show(e&&e.message?e.message:"PDF kerdes-valasz hiba.")}finally{e.setProperty("/generating",false)}},onRunDummy7Compare:async function(){var e=this.getView().getModel("jokers");var a=(e.getProperty("/dummy7CompanyA")||"").trim();var s=(e.getProperty("/dummy7CompanyB")||"").trim();var o=(e.getProperty("/dummy7Focus")||"").trim();if(!a||!s){t.show("Add meg mindket ceg nevet.");return}if(a.charAt(0)!=='"'||a.charAt(a.length-1)!=='"'||s.charAt(0)!=='"'||s.charAt(s.length-1)!=='"'){t.show('A ceg neveket idezojelben add meg, pl.: "Roli Foods".');return}e.setProperty("/generating",true);e.setProperty("/dummy7Result","PDF generalas folyamatban...");try{var n=await r.runDummy7Compare({companyA:a,companyB:s,focus:o});this._downloadDummy7Pdf(n.blob,n.fileName||"dummy7_osszehasonlitas.pdf");e.setProperty("/dummy7Result","Kesz. A PDF letoltes elindult.")}catch(r){t.show(r&&r.message?r.message:"Dummy7 hiba tortent.");e.setProperty("/dummy7Result","Hiba tortent a PDF generalas soran.")}finally{e.setProperty("/generating",false)}},onRunDummy4:async function(){var e=this.getView().getModel("jokers");var a=(e.getProperty("/dummy4Question")||"").trim();var s=(e.getProperty("/dummy4SchemaHint")||"").trim();if(!a){t.show("A kerdes mezot toltsd ki.");return}if(!s){t.show("A schema hint mezot toltsd ki.");return}e.setProperty("/generating",true);e.setProperty("/dummy4GeneratedSql","");e.setProperty("/dummy4Summary","");e.setProperty("/dummy4Rows",[]);e.setProperty("/dummy4ChartReady",false);this._resetDummy4Chart();this._resetDummy4LocalChart();this._rebindDummy4PreviewTable();try{var o=await r.runDummy4({question:a,schemaHint:s});e.setProperty("/dummy4GeneratedSql",o.generatedSql||"");e.setProperty("/dummy4Summary",o.summary||"");e.setProperty("/dummy4Rows",o.rows||[]);this._rebindDummy4PreviewTable();this._renderDummy4LocalChart(o.rows||[])}catch(e){t.show(e&&e.message?e.message:"Dummy4 hiba tortent.")}finally{e.setProperty("/generating",false)}},onRefreshDummy4SchemaHint:async function(){var e=this.getView().getModel("jokers");e.setProperty("/generating",true);try{var a=await r.getDummy4SchemaHint();e.setProperty("/dummy4SchemaHint",a&&a.schemaHint?a.schemaHint:"");t.show("Schema hint frissitve.")}catch(e){t.show(e&&e.message?e.message:"Schema hint frissitesi hiba.")}finally{e.setProperty("/generating",false)}},onRunSmartSegmentation:async function(){var e=this.getView().getModel("jokers");var a=!!e.getProperty("/smartSegSqlEnabled");var s=!!e.getProperty("/smartSegRagEnabled");var o=String(e.getProperty("/smartSegSqlPrompt")||"").trim();var n=String(e.getProperty("/smartSegRagPrompt")||"").trim();var i=String(e.getProperty("/smartSegCombineMode")||"AND").toUpperCase();if(!a&&!s){t.show("Kapcsolj be legalabb egy adatforrast.");return}if(a&&!o){t.show("Az SQL szabadszavas felteteleket add meg.");return}if(s&&!n){t.show("A RAG keresesi leirast add meg.");return}e.setProperty("/smartSegBusy",true);e.setProperty("/smartSegError","");this._smartSegAppendChat("user",[a?"[SQL] "+o:"",s?"[RAG] "+n:"",a&&s?"[Kombinalas] "+i:""].filter(Boolean).join("\n"));try{var m=await r.runSmartSegmentation({sql_enabled:a,rag_enabled:s,combine_mode:i,sql_prompt:o,rag_prompt:n});e.setProperty("/smartSegSqlMeta",m.sql||null);e.setProperty("/smartSegRagMeta",m.rag||null);e.setProperty("/smartSegResultRows",m.result&&m.result.rows||[]);e.setProperty("/smartSegResultColumns",m.result&&m.result.columns||[]);e.setProperty("/smartSegTotalCount",Number(m.result&&m.result.total_count||0));e.setProperty("/smartSegSelectedRecordIds",[]);e.setProperty("/smartSegPage",1);if(!e.getProperty("/smartSegSortKey")){e.setProperty("/smartSegSortKey",(m.result&&m.result.columns||[])[0]||"")}this._applySmartSegClientView();this._rebindSmartSegResultTable();this._smartSegAppendChat("assistant",this._buildSmartSegSummaryText(m))}catch(r){var u=r&&r.message?r.message:"Smart Segmentation hiba.";e.setProperty("/smartSegError",u);this._smartSegAppendChat("assistant","Hiba: "+u);t.show(u)}finally{e.setProperty("/smartSegBusy",false)}},onSmartSegSearch:function(){this._syncSmartSegSelectionsFromTable();this._applySmartSegClientView();this._rebindSmartSegResultTable()},onSmartSegSearchLive:function(){this._syncSmartSegSelectionsFromTable();this._applySmartSegClientView();this._rebindSmartSegResultTable()},onSmartSegSortChange:function(){this._syncSmartSegSelectionsFromTable();this._applySmartSegClientView();this._rebindSmartSegResultTable()},onSmartSegSortDirChange:function(e){var t=String(e.getParameter("item").getKey()||"asc");this.getView().getModel("jokers").setProperty("/smartSegSortDir",t);this._syncSmartSegSelectionsFromTable();this._applySmartSegClientView();this._rebindSmartSegResultTable()},onSmartSegPrevPage:function(){var e=this.getView().getModel("jokers");this._syncSmartSegSelectionsFromTable();var t=Math.max(1,Number(e.getProperty("/smartSegPage")||1)-1);e.setProperty("/smartSegPage",t);this._applySmartSegClientView();this._rebindSmartSegResultTable()},onSmartSegNextPage:function(){var e=this.getView().getModel("jokers");this._syncSmartSegSelectionsFromTable();var t=Number(e.getProperty("/smartSegPage")||1)+1;e.setProperty("/smartSegPage",t);this._applySmartSegClientView();this._rebindSmartSegResultTable()},onSmartSegSelectionChange:function(){this._syncSmartSegSelectionsFromTable()},onSmartSegSendToCrm:async function(){var e=this.getView().getModel("jokers");var a=e.getProperty("/smartSegSelectedRecordIds")||[];try{var s=await r.sendSmartSegmentationToCrm({record_ids:a});t.show(s&&s.message?s.message:"Jövőbeli funkció.")}catch(e){t.show("Jövőbeli funkció.")}},onCancel:function(){var e=this.getView().getModel("jokers");e.setProperty("/promptInput","");e.setProperty("/resultText","");e.setProperty("/dummy4Question","");e.setProperty("/dummy4GeneratedSql","");e.setProperty("/dummy4Summary","");e.setProperty("/dummy4Rows",[]);e.setProperty("/dummy4ChartReady",false);this._resetDummy5State();this._resetDummy7State();this._resetSmartSegState();this._resetDummy4Chart();this._resetDummy4LocalChart();this._rebindDummy4PreviewTable();this._rebindSmartSegResultTable();this.getOwnerComponent().getRouter().navTo("mainMenu",{menuKey:"jokers"})},_onRouteMatched:function(e){var t=e.getParameter("arguments").jokerId;var r=this.getView().getModel("jokers");var a=r.getProperty("/tiles")||[];var s=a.find(function(e){return e.id===t});if(s){r.setProperty("/selectedJoker",s);r.setProperty("/resultText","");if(s.id==="dummy-4"){r.setProperty("/dummy4GeneratedSql","");r.setProperty("/dummy4Summary","");r.setProperty("/dummy4Rows",[]);r.setProperty("/dummy4ChartReady",false);this._resetDummy4Chart();this._resetDummy4LocalChart();this._rebindDummy4PreviewTable()}else if(s.id==="dummy-5"){this._resetDummy5State()}else if(s.id==="dummy-7"){this._resetDummy7State()}else if(s.id==="dummy-8"){this._resetSmartSegState();this._rebindSmartSegResultTable()}}},_resetDummy5State:function(){var e=this.getView().getModel("jokers");e.setProperty("/dummy5DocToken","");e.setProperty("/dummy5FileName","");e.setProperty("/dummy5Summary","");e.setProperty("/dummy5Question","");e.setProperty("/dummy5Answer","");var t=this.byId("dummy5FileUploader");if(t&&t.clear){t.clear()}},_resetDummy7State:function(){var e=this.getView().getModel("jokers");e.setProperty("/dummy7CompanyA","");e.setProperty("/dummy7CompanyB","");e.setProperty("/dummy7Focus","");e.setProperty("/dummy7Result","")},_resetSmartSegState:function(){var e=this.getView().getModel("jokers");e.setProperty("/smartSegSqlEnabled",true);e.setProperty("/smartSegRagEnabled",false);e.setProperty("/smartSegCombineMode","AND");e.setProperty("/smartSegSqlPrompt","");e.setProperty("/smartSegRagPrompt","");e.setProperty("/smartSegChatMessages",[]);e.setProperty("/smartSegBusy",false);e.setProperty("/smartSegError","");e.setProperty("/smartSegSqlMeta",null);e.setProperty("/smartSegRagMeta",null);e.setProperty("/smartSegResultRows",[]);e.setProperty("/smartSegResultColumns",[]);e.setProperty("/smartSegDisplayRows",[]);e.setProperty("/smartSegSearch","");e.setProperty("/smartSegSortKey","");e.setProperty("/smartSegSortDir","asc");e.setProperty("/smartSegPage",1);e.setProperty("/smartSegTotalCount",0);e.setProperty("/smartSegFilteredCount",0);e.setProperty("/smartSegSelectedRecordIds",[])},_smartSegAppendChat:function(e,t){var r=this.getView().getModel("jokers");var a=r.getProperty("/smartSegChatMessages")||[];a.push({role:e,content:String(t||"")});r.setProperty("/smartSegChatMessages",a.slice(-20))},_buildSmartSegSummaryText:function(e){var t=e&&e.sql?e.sql:{};var r=e&&e.rag?e.rag:{};var a=e&&e.combine?e.combine:{};var s=[];if(t.active){s.push("SQL talalatok: "+Number(t.matched_count||0))}if(r.active){s.push("RAG talalatok: "+Number(r.matched_count||0))}s.push("Vegso talalatok ("+(a.operator||"AND")+"): "+Number(a.final_count||0));if(t.interpreted_query){s.push("SQL ertelmezes: "+t.interpreted_query)}if(r.note){s.push("RAG megjegyzes: "+r.note)}return s.join("\n")},_applySmartSegClientView:function(){var e=this.getView().getModel("jokers");var t=(e.getProperty("/smartSegResultRows")||[]).slice();var r=String(e.getProperty("/smartSegSearch")||"").trim().toLowerCase();var a=String(e.getProperty("/smartSegSortKey")||"").trim();var s=String(e.getProperty("/smartSegSortDir")||"asc");var o=Math.max(1,Number(e.getProperty("/smartSegPageSize")||20));var n=Math.max(1,Number(e.getProperty("/smartSegPage")||1));if(r){t=t.filter(function(e){return Object.keys(e||{}).some(function(t){return String(e[t]==null?"":e[t]).toLowerCase().indexOf(r)>=0})})}if(a){t.sort(function(e,t){var r=e?e[a]:null;var s=t?t[a]:null;var o=String(r==null?"":r).toLowerCase();var n=String(s==null?"":s).toLowerCase();if(o===n){return 0}return o<n?-1:1});if(s==="desc"){t.reverse()}}var i=Math.max(1,Math.ceil(t.length/o));if(n>i){n=i;e.setProperty("/smartSegPage",n)}var m=(n-1)*o;var u=t.slice(m,m+o);e.setProperty("/smartSegFilteredCount",t.length);e.setProperty("/smartSegDisplayRows",u)},_rebindSmartSegResultTable:function(){var e=this.byId("smartSegResultTable");var t=this.getView().getModel("jokers");var r=t.getProperty("/smartSegDisplayRows")||[];var a=t.getProperty("/smartSegResultColumns")||[];if(!e){return}e.unbindItems();e.removeAllColumns();e.removeSelections(true);if(!a.length){return}a.forEach(function(t){e.addColumn(new o({header:new n({text:t})}))});e.bindItems({path:"jokers>/smartSegDisplayRows",template:new i({cells:a.map(function(e){return new n({text:"{jokers>"+e+"}",wrapping:true})})}),templateShareable:false});if(r.length>0){setTimeout(this._restoreSmartSegSelectionsToTable.bind(this),0)}},_syncSmartSegSelectionsFromTable:function(){var e=this.byId("smartSegResultTable");var t=this.getView().getModel("jokers");if(!e){return}var r=t.getProperty("/smartSegSelectedRecordIds")||[];var a={};r.forEach(function(e){a[String(e)]=true});(e.getItems()||[]).forEach(function(e){var t=e.getBindingContext("jokers");var r=t?t.getObject():null;var s=String(r&&(r.record_id||r.CustomerId||"")||"");if(!s){return}if(e.getSelected()){a[s]=true}else{delete a[s]}});t.setProperty("/smartSegSelectedRecordIds",Object.keys(a))},_restoreSmartSegSelectionsToTable:function(){var e=this.byId("smartSegResultTable");var t=this.getView().getModel("jokers");var r=t.getProperty("/smartSegSelectedRecordIds")||[];var a={};r.forEach(function(e){a[String(e)]=true});(e&&e.getItems?e.getItems():[]).forEach(function(e){var t=e.getBindingContext("jokers");var r=t?t.getObject():null;var s=String(r&&(r.record_id||r.CustomerId||"")||"");e.setSelected(!!a[s])})},_downloadDummy7Pdf:function(e,t){if(!e){return}var r=URL.createObjectURL(e);var a=document.createElement("a");a.href=r;a.download=t||"dummy7_osszehasonlitas.pdf";document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(r)},_renderDummy4LocalChart:function(e){var t=this.byId("dummy4LocalChartHost");var r=this._extractDummy4Columns(e);var a=this._findNumericColumns(e,r);var o=a[0]||"";var n=r.find(function(e){return e!==o})||r[0];this._resetDummy4LocalChart();if(!t||!n||!o){return}var i=(e||[]).map(function(e){var t=Object.assign({},e||{});t[o]=this._toNumberOrNull(t[o]);return t}.bind(this));var d=new u({dimensions:[new l({name:n,value:"{"+n+"}"})],measures:[new y({name:o,value:"{"+o+"}"})],data:{path:"/rows"}});var S=new m({width:"100%",height:"360px",vizType:"column",dataset:d});S.setModel(new s({rows:i}));S.addFeed(new g({uid:"categoryAxis",type:"Dimension",values:[n]}));S.addFeed(new g({uid:"valueAxis",type:"Measure",values:[o]}));S.setVizProperties({title:{visible:false},legend:{visible:false},plotArea:{dataLabel:{visible:true}}});t.addItem(S)},_resetDummy4LocalChart:function(){var e=this.byId("dummy4LocalChartHost");if(!e){return}e.removeAllItems()},_findNumericColumns:function(e,t){return(t||[]).filter(function(t){var r=false;var a=true;(e||[]).forEach(function(e){var s=e?e[t]:null;if(s==null||s===""){return}r=true;if(this._toNumberOrNull(s)==null){a=false}}.bind(this));return r&&a}.bind(this))},_toNumberOrNull:function(e){if(typeof e==="number"&&isFinite(e)){return e}if(typeof e==="string"){var t=e.trim();if(!t){return null}var r=Number(t);if(isFinite(r)){return r}}return null},_rebindDummy4PreviewTable:function(){var e=this.byId("dummy4PreviewTable");var t=this.getView().getModel("jokers");var r=t.getProperty("/dummy4Rows")||[];var a=this._extractDummy4Columns(r);if(!e){return}e.unbindItems();e.removeAllColumns();if(a.length===0){return}a.forEach(function(t){e.addColumn(new o({header:new n({text:t})}))});var s=a.map(function(e){return new n({text:"{jokers>"+e+"}",wrapping:true})});var m=new i({cells:s});e.bindItems({path:"jokers>/dummy4Rows",template:m,templateShareable:false})},_extractDummy4Columns:function(e){var t={};var r=[];(e||[]).forEach(function(e){Object.keys(e||{}).forEach(function(e){if(e.indexOf("__")===0||t[e]){return}t[e]=true;r.push(e)})});return r},_bindDummy4SmartChart:function(e){var r=this.getView().getModel("jokers");var s=this.byId("dummy4SmartChart");var o=this;if(!s||!e){r.setProperty("/dummy4ChartReady",false);return}var n="/api/jokers/dummy4/chart/"+encodeURIComponent(e)+"/";var i=new a(n,{useBatch:false});r.setProperty("/dummy4ChartReady",false);i.attachMetadataLoaded(function(){s.setModel(i);if(s.setChartType){s.setChartType("column")}r.setProperty("/dummy4ChartReady",true);o._rebindDummy4SmartChartSafely(s)});i.attachMetadataFailed(function(){r.setProperty("/dummy4ChartReady",false);t.show("Smart Chart metadata betoltese sikertelen.")})},_rebindDummy4SmartChartSafely:function(e){if(!e){return}if(e.isInitialised&&e.isInitialised()){e.rebindChart();return}e.attachInitialise(function(){e.rebindChart()})},_resetDummy4Chart:function(){var e=this.byId("dummy4SmartChart");if(!e){return}var t=e.getModel();if(t&&t.destroy){t.destroy()}e.setModel(null)},_runGenerate:async function(e){var a=this.getView().getModel("jokers");var s=a.getProperty("/selectedJoker");var o=(a.getProperty("/promptInput")||"").trim();if(!s){t.show("Nincs kivalasztott joker.");return}if(!o){t.show("Adj meg szoveget a folytatashoz.");return}a.setProperty("/generating",true);try{var n=await r.generate({title:s.title,systemPrompt:e?s.systemPrompt:"",inputText:o});a.setProperty("/resultText",n)}catch(e){t.show(e&&e.message?e.message:"Hiba tortent a Generate hivaskor.")}finally{a.setProperty("/generating",false)}}})});
//# sourceMappingURL=JokerPrompt.controller.js.map