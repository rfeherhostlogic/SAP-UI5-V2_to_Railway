sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/suite/ui/commons/demo/tutorial/service/AiService","sap/ui/model/odata/v2/ODataModel","sap/ui/model/json/JSONModel","sap/m/Column","sap/m/Text","sap/m/ColumnListItem","sap/viz/ui5/controls/VizFrame","sap/viz/ui5/data/FlattenedDataset","sap/viz/ui5/data/DimensionDefinition","sap/viz/ui5/data/MeasureDefinition","sap/viz/ui5/controls/common/feeds/FeedItem"],function(e,t,r,a,s,m,o,n,i,u,y,l,d){"use strict";return e.extend("sap.suite.ui.commons.demo.tutorial.controller.JokerPrompt",{onInit:function(){this.getOwnerComponent().getRouter().getRoute("jokerPrompt").attachPatternMatched(this._onRouteMatched,this)},onGenerate:async function(){await this._runGenerate(true)},onSend:async function(){await this._runGenerate(false)},onDummy5FileChange:async function(e){var a=this.getView().getModel("jokers");var s=e&&e.getParameter?e.getParameter("files"):null;var m=s&&s[0]?s[0]:null;if(!m){t.show("Valassz egy PDF fajlt.");return}a.setProperty("/generating",true);a.setProperty("/dummy5Summary","");a.setProperty("/dummy5Answer","");a.setProperty("/dummy5DocToken","");try{var o=await r.uploadDummy5Pdf(m);a.setProperty("/dummy5DocToken",o.docToken||"");a.setProperty("/dummy5FileName",o.fileName||m.name||"");t.show("PDF feltoltve es feldolgozva.")}catch(e){t.show(e&&e.message?e.message:"PDF feltoltesi hiba.")}finally{a.setProperty("/generating",false)}},onRunDummy5Summary:async function(){var e=this.getView().getModel("jokers");var a=(e.getProperty("/dummy5DocToken")||"").trim();if(!a){t.show("Elobb tolts fel egy PDF-et.");return}e.setProperty("/generating",true);try{var s=await r.summarizeDummy5({docToken:a});e.setProperty("/dummy5Summary",s.summary||"")}catch(e){t.show(e&&e.message?e.message:"PDF osszegzes hiba.")}finally{e.setProperty("/generating",false)}},onRunDummy5Ask:async function(){var e=this.getView().getModel("jokers");var a=(e.getProperty("/dummy5DocToken")||"").trim();var s=(e.getProperty("/dummy5Question")||"").trim();if(!a){t.show("Elobb tolts fel egy PDF-et.");return}if(!s){t.show("A kerdes mezot toltsd ki.");return}e.setProperty("/generating",true);try{var m=await r.askDummy5({docToken:a,question:s});e.setProperty("/dummy5Answer",m.answer||"")}catch(e){t.show(e&&e.message?e.message:"PDF kerdes-valasz hiba.")}finally{e.setProperty("/generating",false)}},onRunDummy7Compare:async function(){var e=this.getView().getModel("jokers");var a=(e.getProperty("/dummy7CompanyA")||"").trim();var s=(e.getProperty("/dummy7CompanyB")||"").trim();var m=(e.getProperty("/dummy7Focus")||"").trim();if(!a||!s){t.show("Add meg mindket ceg nevet.");return}if(a.charAt(0)!=='"'||a.charAt(a.length-1)!=='"'||s.charAt(0)!=='"'||s.charAt(s.length-1)!=='"'){t.show('A ceg neveket idezojelben add meg, pl.: "Roli Foods".');return}e.setProperty("/generating",true);e.setProperty("/dummy7Result","PDF generalas folyamatban...");try{var o=await r.runDummy7Compare({companyA:a,companyB:s,focus:m});this._downloadDummy7Pdf(o.blob,o.fileName||"dummy7_osszehasonlitas.pdf");e.setProperty("/dummy7Result","Kesz. A PDF letoltes elindult.")}catch(r){t.show(r&&r.message?r.message:"Dummy7 hiba tortent.");e.setProperty("/dummy7Result","Hiba tortent a PDF generalas soran.")}finally{e.setProperty("/generating",false)}},onRunDummy4:async function(){var e=this.getView().getModel("jokers");var a=(e.getProperty("/dummy4Question")||"").trim();var s=(e.getProperty("/dummy4SchemaHint")||"").trim();if(!a){t.show("A kerdes mezot toltsd ki.");return}if(!s){t.show("A schema hint mezot toltsd ki.");return}e.setProperty("/generating",true);e.setProperty("/dummy4GeneratedSql","");e.setProperty("/dummy4Summary","");e.setProperty("/dummy4Rows",[]);e.setProperty("/dummy4ChartReady",false);this._resetDummy4Chart();this._resetDummy4LocalChart();this._rebindDummy4PreviewTable();try{var m=await r.runDummy4({question:a,schemaHint:s});e.setProperty("/dummy4GeneratedSql",m.generatedSql||"");e.setProperty("/dummy4Summary",m.summary||"");e.setProperty("/dummy4Rows",m.rows||[]);this._rebindDummy4PreviewTable();this._renderDummy4LocalChart(m.rows||[])}catch(e){t.show(e&&e.message?e.message:"Dummy4 hiba tortent.")}finally{e.setProperty("/generating",false)}},onRefreshDummy4SchemaHint:async function(){var e=this.getView().getModel("jokers");e.setProperty("/generating",true);try{var a=await r.getDummy4SchemaHint();e.setProperty("/dummy4SchemaHint",a&&a.schemaHint?a.schemaHint:"");t.show("Schema hint frissitve.")}catch(e){t.show(e&&e.message?e.message:"Schema hint frissitesi hiba.")}finally{e.setProperty("/generating",false)}},onCancel:function(){var e=this.getView().getModel("jokers");e.setProperty("/promptInput","");e.setProperty("/resultText","");e.setProperty("/dummy4Question","");e.setProperty("/dummy4GeneratedSql","");e.setProperty("/dummy4Summary","");e.setProperty("/dummy4Rows",[]);e.setProperty("/dummy4ChartReady",false);this._resetDummy5State();this._resetDummy7State();this._resetDummy4Chart();this._resetDummy4LocalChart();this._rebindDummy4PreviewTable();this.getOwnerComponent().getRouter().navTo("mainMenu",{menuKey:"jokers"})},_onRouteMatched:function(e){var t=e.getParameter("arguments").jokerId;var r=this.getView().getModel("jokers");var a=r.getProperty("/tiles")||[];var s=a.find(function(e){return e.id===t});if(s){r.setProperty("/selectedJoker",s);r.setProperty("/resultText","");if(s.id==="dummy-4"){r.setProperty("/dummy4GeneratedSql","");r.setProperty("/dummy4Summary","");r.setProperty("/dummy4Rows",[]);r.setProperty("/dummy4ChartReady",false);this._resetDummy4Chart();this._resetDummy4LocalChart();this._rebindDummy4PreviewTable()}else if(s.id==="dummy-5"){this._resetDummy5State()}else if(s.id==="dummy-7"){this._resetDummy7State()}}},_resetDummy5State:function(){var e=this.getView().getModel("jokers");e.setProperty("/dummy5DocToken","");e.setProperty("/dummy5FileName","");e.setProperty("/dummy5Summary","");e.setProperty("/dummy5Question","");e.setProperty("/dummy5Answer","");var t=this.byId("dummy5FileUploader");if(t&&t.clear){t.clear()}},_resetDummy7State:function(){var e=this.getView().getModel("jokers");e.setProperty("/dummy7CompanyA","");e.setProperty("/dummy7CompanyB","");e.setProperty("/dummy7Focus","");e.setProperty("/dummy7Result","")},_downloadDummy7Pdf:function(e,t){if(!e){return}var r=URL.createObjectURL(e);var a=document.createElement("a");a.href=r;a.download=t||"dummy7_osszehasonlitas.pdf";document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(r)},_renderDummy4LocalChart:function(e){var t=this.byId("dummy4LocalChartHost");var r=this._extractDummy4Columns(e);var a=this._findNumericColumns(e,r);var m=a[0]||"";var o=r.find(function(e){return e!==m})||r[0];this._resetDummy4LocalChart();if(!t||!o||!m){return}var n=(e||[]).map(function(e){var t=Object.assign({},e||{});t[m]=this._toNumberOrNull(t[m]);return t}.bind(this));var h=new u({dimensions:[new y({name:o,value:"{"+o+"}"})],measures:[new l({name:m,value:"{"+m+"}"})],data:{path:"/rows"}});var c=new i({width:"100%",height:"360px",vizType:"column",dataset:h});c.setModel(new s({rows:n}));c.addFeed(new d({uid:"categoryAxis",type:"Dimension",values:[o]}));c.addFeed(new d({uid:"valueAxis",type:"Measure",values:[m]}));c.setVizProperties({title:{visible:false},legend:{visible:false},plotArea:{dataLabel:{visible:true}}});t.addItem(c)},_resetDummy4LocalChart:function(){var e=this.byId("dummy4LocalChartHost");if(!e){return}e.removeAllItems()},_findNumericColumns:function(e,t){return(t||[]).filter(function(t){var r=false;var a=true;(e||[]).forEach(function(e){var s=e?e[t]:null;if(s==null||s===""){return}r=true;if(this._toNumberOrNull(s)==null){a=false}}.bind(this));return r&&a}.bind(this))},_toNumberOrNull:function(e){if(typeof e==="number"&&isFinite(e)){return e}if(typeof e==="string"){var t=e.trim();if(!t){return null}var r=Number(t);if(isFinite(r)){return r}}return null},_rebindDummy4PreviewTable:function(){var e=this.byId("dummy4PreviewTable");var t=this.getView().getModel("jokers");var r=t.getProperty("/dummy4Rows")||[];var a=this._extractDummy4Columns(r);if(!e){return}e.unbindItems();e.removeAllColumns();if(a.length===0){return}a.forEach(function(t){e.addColumn(new m({header:new o({text:t})}))});var s=a.map(function(e){return new o({text:"{jokers>"+e+"}",wrapping:true})});var i=new n({cells:s});e.bindItems({path:"jokers>/dummy4Rows",template:i,templateShareable:false})},_extractDummy4Columns:function(e){var t={};var r=[];(e||[]).forEach(function(e){Object.keys(e||{}).forEach(function(e){if(e.indexOf("__")===0||t[e]){return}t[e]=true;r.push(e)})});return r},_bindDummy4SmartChart:function(e){var r=this.getView().getModel("jokers");var s=this.byId("dummy4SmartChart");var m=this;if(!s||!e){r.setProperty("/dummy4ChartReady",false);return}var o="/api/jokers/dummy4/chart/"+encodeURIComponent(e)+"/";var n=new a(o,{useBatch:false});r.setProperty("/dummy4ChartReady",false);n.attachMetadataLoaded(function(){s.setModel(n);if(s.setChartType){s.setChartType("column")}r.setProperty("/dummy4ChartReady",true);m._rebindDummy4SmartChartSafely(s)});n.attachMetadataFailed(function(){r.setProperty("/dummy4ChartReady",false);t.show("Smart Chart metadata betoltese sikertelen.")})},_rebindDummy4SmartChartSafely:function(e){if(!e){return}if(e.isInitialised&&e.isInitialised()){e.rebindChart();return}e.attachInitialise(function(){e.rebindChart()})},_resetDummy4Chart:function(){var e=this.byId("dummy4SmartChart");if(!e){return}var t=e.getModel();if(t&&t.destroy){t.destroy()}e.setModel(null)},_runGenerate:async function(e){var a=this.getView().getModel("jokers");var s=a.getProperty("/selectedJoker");var m=(a.getProperty("/promptInput")||"").trim();if(!s){t.show("Nincs kivalasztott joker.");return}if(!m){t.show("Adj meg szoveget a folytatashoz.");return}a.setProperty("/generating",true);try{var o=await r.generate({title:s.title,systemPrompt:e?s.systemPrompt:"",inputText:m});a.setProperty("/resultText",o)}catch(e){t.show(e&&e.message?e.message:"Hiba tortent a Generate hivaskor.")}finally{a.setProperty("/generating",false)}}})});
//# sourceMappingURL=JokerPrompt.controller.js.map